<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>注册 · 漫游聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('chat-theme');
        var theme = stored === 'dark' || stored === 'light'
          ? stored
          : (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.dataset.theme = theme;
      } catch (e) {
        document.documentElement.dataset.theme = 'light';
      }
    })();
  </script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Noto Sans SC","PingFang SC","Microsoft YaHei","Helvetica Neue",Arial,sans-serif;
      --bg: linear-gradient(180deg,#eef2ff,#f5f3ff);
      --bg-accent1: rgba(37,99,235,0.2);
      --bg-accent2: rgba(124,58,237,0.22);
      --card-bg: rgba(255,255,255,0.92);
      --card-shadow1: rgba(15,23,42,0.16);
      --card-shadow2: rgba(59,130,246,0.12);
      --text: #0f172a;
      --text-muted: #475569;
      --hero-bg: linear-gradient(150deg, rgba(37,99,235,0.94), rgba(124,58,237,0.88));
      --hero-text: rgba(255,255,255,0.86);
      --button-bg: linear-gradient(135deg,#2563eb,#7c3aed);
      --button-shadow1: rgba(79,70,229,0.32);
      --button-shadow2: rgba(37,99,235,0.2);
      --input-bg: rgba(255,255,255,0.86);
      --input-border: rgba(148,163,184,0.4);
      --badge-bg: rgba(15,23,42,0.18);
    }
    :root[data-theme="dark"] {
      --bg: linear-gradient(180deg,#0f172a,#111827);
      --bg-accent1: rgba(56,189,248,0.12);
      --bg-accent2: rgba(139,92,246,0.12);
      --card-bg: rgba(15,23,42,0.85);
      --card-shadow1: rgba(8,145,178,0.24);
      --card-shadow2: rgba(59,130,246,0.2);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --hero-bg: linear-gradient(150deg, rgba(37,99,235,0.56), rgba(124,58,237,0.58));
      --hero-text: rgba(226,232,240,0.82);
      --button-shadow1: rgba(59,130,246,0.42);
      --button-shadow2: rgba(30,64,175,0.35);
      --input-bg: rgba(30,41,59,0.78);
      --input-border: rgba(148,163,184,0.32);
      --badge-bg: rgba(255,255,255,0.16);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(1.4rem, 4vw, 3rem);
      background:
        radial-gradient(130% 120% at 15% -10%, var(--bg-accent1), transparent 55%),
        radial-gradient(130% 120% at 75% 0%, var(--bg-accent2), transparent 60%),
        var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }
    .layout {
      width: min(1080px, 100%);
      display: grid;
      gap: clamp(2rem, 4vw, 3rem);
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      align-items: stretch;
    }
    .card {
      background: var(--card-bg);
      border-radius: 32px;
      box-shadow:
        0 34px 76px var(--card-shadow1),
        0 18px 32px var(--card-shadow2);
      backdrop-filter: blur(22px);
      overflow: hidden;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .card.hero {
      padding: clamp(2.2rem, 4vw, 3.4rem);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1.8rem;
      background: var(--hero-bg);
      color: #ffffff;
      position: relative;
    }
    .card.hero::after {
      content: "";
      position: absolute;
      inset: 15% -25% auto auto;
      width: clamp(240px, 45vw, 360px);
      height: clamp(240px, 45vw, 360px);
      background: radial-gradient(circle, rgba(255,255,255,0.3), transparent 65%);
      opacity: 0.78;
      pointer-events: none;
    }
    .card.hero h1 {
      font-size: clamp(2.2rem, 4vw, 2.7rem);
      font-weight: 700;
      letter-spacing: 0.05em;
      line-height: 1.2;
    }
    .card.hero p {
      font-size: 1.05rem;
      line-height: 1.85;
      color: var(--hero-text);
      max-width: 440px;
    }
    .card.hero ul {
      list-style: none;
      display: grid;
      gap: 1.1rem;
    }
    .card.hero li {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 1rem;
    }
    .card.hero li span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: var(--badge-bg);
      font-weight: 600;
    }
    .form-wrap {
      padding: clamp(2.2rem, 4vw, 3.4rem);
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
    }
    .form-header {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .form-header h2 {
      font-size: clamp(1.8rem, 3vw, 2rem);
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .form-header p {
      color: var(--text-muted);
      font-size: 1rem;
      line-height: 1.7;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      font-weight: 600;
      color: var(--text);
      font-size: 1rem;
    }
    input[type="email"],
    input[type="text"],
    input[type="password"],
    input[type="url"] {
      width: 100%;
      padding: 0.95rem 1.15rem;
      border-radius: 18px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      font: inherit;
      color: var(--text);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    input:focus,
    input[type="file"]:focus-visible {
      outline: none;
      border-color: rgba(79,70,229,0.9);
      box-shadow: 0 0 0 4px rgba(79,70,229,0.18);
      background: rgba(255,255,255,0.97);
    }
    :root[data-theme="dark"] input:focus {
      background: rgba(15,23,42,0.92);
    }
    .two-col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .radio-group {
      display: grid;
      gap: 0.8rem;
    }
    .radio-option {
      display: flex;
      align-items: left;
      gap: 0.85rem;
      padding: 0.85rem 1.1rem;
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 18px;
      background: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    :root[data-theme="dark"] .radio-option {
      background: rgba(30,41,59,0.72);
      border-color: rgba(148,163,184,0.25);
    }
    .radio-option input {
      accent-color: #6366f1;
      transform: scale(1.15);
    }
    .radio-option.active {
      border-color: rgba(79,70,229,0.9);
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 24px rgba(79,70,229,0.16);
    }
    :root[data-theme="dark"] .radio-option.active {
      background: rgba(59,130,246,0.18);
      box-shadow: 0 10px 24px rgba(59,130,246,0.32);
    }
    .avatar-preview {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      padding: 1rem 1.1rem;
      border-radius: 20px;
      background: rgba(15,23,42,0.05);
      border: 1px dashed rgba(79,70,229,0.22);
    }
    :root[data-theme="dark"] .avatar-preview {
      background: rgba(30,41,59,0.6);
      border-color: rgba(148,163,184,0.28);
    }
    .avatar-preview img {
      width: 72px;
      height: 72px;
      border-radius: 20px;
      object-fit: cover;
      box-shadow: 0 18px 32px rgba(15,23,42,0.18);
    }
    .avatar-preview span {
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .hidden {
      display: none !important;
    }
    .file-input {
      padding: 0.75rem;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.8);
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    :root[data-theme="dark"] .file-input {
      background: rgba(30,41,59,0.65);
      border-color: rgba(148,163,184,0.32);
      color: #cbd5f5;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      margin-top: 0.6rem;
    }
    button[type="submit"] {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.8rem;
      border-radius: 999px;
      border: none;
      background: var(--button-bg);
      color: #ffffff;
      font-weight: 600;
      font-size: 1.02rem;
      cursor: pointer;
      box-shadow:
        0 20px 40px var(--button-shadow1),
        0 12px 26px var(--button-shadow2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 24px 46px rgba(79,70,229,0.4),
        0 14px 30px rgba(37,99,235,0.24);
    }
    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    .links {
      font-size: 0.96rem;
      color: var(--text-muted);
    }
    .links a {
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
    }
    .links a:hover {
      text-decoration: underline;
    }
    .message {
      display: none;
      padding: 0.9rem 1.1rem;
      border-radius: 18px;
      font-size: 0.97rem;
      line-height: 1.6;
    }
    .message.show {
      display: block;
    }
    .message.error {
      background: rgba(248,113,113,0.12);
      color: #b91c1c;
      border: 1px solid rgba(239,68,68,0.24);
    }
    .message.success {
      background: rgba(34,197,94,0.12);
      color: #047857;
      border: 1px solid rgba(16,185,129,0.2);
    }
    @media (max-width: 840px) {
      body {
        padding: 1.1rem;
      }
      .layout {
        gap: 1.5rem;
      }
      .card {
        border-radius: 26px;
      }
      .card.hero {
        border-radius: 26px;
      }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="card hero">
      <h1>注册漫游聊天室</h1>
      <p>三步加入：填写邮箱、设置昵称与密码、选择头像。验证邮箱后即可发言。</p>
      <ul>
        <li><span>1</span> 支持 Cravatar（兼容 Gravatar）、外链或直接上传头像</li>
        <li><span>2</span> 注册后自动发送验证邮件，请在 24 小时内完成</li>
        <li><span>3</span> 未验证前可浏览消息，验证后解锁发言</li>
      </ul>
    </section>

    <section class="card">
      <div class="form-wrap">
        <div class="form-header">
          <h2>创建新账号</h2>
          <p>请填写以下信息。我们会向你的邮箱发送验证链接，请注意查收。</p>
        </div>

        <div id="message" class="message" role="alert"></div>

        <form id="register-form" enctype="multipart/form-data" novalidate>
          <label>
            邮箱
            <input type="email" name="email" required placeholder="name@example.com" autocomplete="email">
          </label>

          <label>
            昵称
            <input type="text" name="displayName" required maxlength="32" placeholder="给自己起个名字">
          </label>

          <div class="two-col">
            <label>
              密码
              <input type="password" name="password" required minlength="8" autocomplete="new-password" placeholder="至少 8 个字符">
            </label>
            <label>
              确认密码
              <input type="password" name="passwordConfirm" required minlength="8" autocomplete="new-password" placeholder="再输入一次密码">
            </label>
          </div>

          <div>
            <label>头像选择</label>
            <div class="radio-group" id="avatar-options">
              <label class="radio-option active">
                <input type="radio" name="avatarSource" value="gravatar" checked>
                <div>
                  <strong>使用 Cravatar</strong>
                  <div>兼容 Gravatar，国内节点更快。邮箱没有头像时会生成 identicon。</div>
                </div>
              </label>

              <label class="radio-option">
                <input type="radio" name="avatarSource" value="url">
                <div>
                  <strong>自定义图片链接</strong>
                  <div>填写一张公开的 http(s) 图片地址作为头像。</div>
                </div>
              </label>

              <label class="radio-option">
                <input type="radio" name="avatarSource" value="upload">
                <div>
                  <strong>上传到服务器</strong>
                  <div>支持 PNG / JPG / GIF / WebP，最大 10 MB。</div>
                </div>
              </label>
            </div>
          </div>

          <label id="avatar-url-field" class="hidden">
            头像图片链接
            <input type="url" name="avatarUrl" placeholder="https://example.com/avatar.png">
          </label>

          <label id="avatar-file-field" class="hidden">
            上传头像
            <input class="file-input" type="file" name="avatarFile" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
          </label>

          <div class="avatar-preview" id="avatar-preview">
            <img id="preview-image" src="https://cravatar.cn/avatar?d=identicon&s=160" alt="头像预览">
            <span id="preview-text">当前预览：Cravatar 自动生成（兼容 Gravatar，国内加载更快）。</span>
          </div>

          <div class="actions">
            <button type="submit" id="submit-btn">
              <span>完成注册并发送验证邮件</span>
            </button>
            <div class="links">
              已有账号？<a href="/login.html">直接登录</a>
            </div>
          </div>
        </form>
      </div>
    </section>
  </div>

  <script src="/theme.js"></script>
  <script>
    Theme.init();
  </script>
  <script>
    const form = document.getElementById('register-form');
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');

    const radioOptions = Array.from(document.querySelectorAll('#avatar-options .radio-option'));
    const avatarUrlField = document.getElementById('avatar-url-field');
    const avatarFileField = document.getElementById('avatar-file-field');
    const previewImage = document.getElementById('preview-image');
    const previewText = document.getElementById('preview-text');
    const emailInput = form.email;

    function md5(str) {
      function add32(a, b) { return (a + b) & 0xffffffff; }
      function cmn(q, a, b, x, s, t) {
        a = add32(add32(a, q), add32(x, t));
        return add32((a << s) | (a >>> (32 - s)), b);
      }
      function ff(a, b, c, d, x, s, t) { return cmn((b & c) | (~b & d), a, b, x, s, t); }
      function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & ~d), a, b, x, s, t); }
      function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
      function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | ~d), a, b, x, s, t); }
      function md5blk(s) {
        const blocks = new Array(16);
        for (let i = 0; i < 16; i++) {
          blocks[i] = s.charCodeAt(i * 4) +
            (s.charCodeAt(i * 4 + 1) << 8) +
            (s.charCodeAt(i * 4 + 2) << 16) +
            (s.charCodeAt(i * 4 + 3) << 24);
        }
        return blocks;
      }
      function calcMD5(x, k) {
        let [a, b, c, d] = x;
        a = ff(a, b, c, d, k[0], 7, -680876936);
        d = ff(d, a, b, c, k[1], 12, -389564586);
        c = ff(c, d, a, b, k[2], 17, 606105819);
        b = ff(b, c, d, a, k[3], 22, -1044525330);
        a = ff(a, b, c, d, k[4], 7, -176418897);
        d = ff(d, a, b, c, k[5], 12, 1200080426);
        c = ff(c, d, a, b, k[6], 17, -1473231341);
        b = ff(b, c, d, a, k[7], 22, -45705983);
        a = ff(a, b, c, d, k[8], 7, 1770035416);
        d = ff(d, a, b, c, k[9], 12, -1958414417);
        c = ff(c, d, a, b, k[10], 17, -42063);
        b = ff(b, c, d, a, k[11], 22, -1990404162);
        a = ff(a, b, c, d, k[12], 7, 1804603682);
        d = ff(d, a, b, c, k[13], 12, -40341101);
        c = ff(c, d, a, b, k[14], 17, -1502002290);
        b = ff(b, c, d, a, k[15], 22, 1236535329);
        a = gg(a, b, c, d, k[1], 5, -165796510);
        d = gg(d, a, b, c, k[6], 9, -1069501632);
        c = gg(c, d, a, b, k[11], 14, 643717713);
        b = gg(b, c, d, a, k[0], 20, -373897302);
        a = gg(a, b, c, d, k[5], 5, -701558691);
        d = gg(d, a, b, c, k[10], 9, 38016083);
        c = gg(c, d, a, b, k[15], 14, -660478335);
        b = gg(b, c, d, a, k[4], 20, -405537848);
        a = gg(a, b, c, d, k[9], 5, 568446438);
        d = gg(d, a, b, c, k[14], 9, -1019803690);
        c = gg(c, d, a, b, k[3], 14, -187363961);
        b = gg(b, c, d, a, k[8], 20, 1163531501);
        a = gg(a, b, c, d, k[13], 5, -1444681467);
        d = gg(d, a, b, c, k[2], 9, -51403784);
        c = gg(c, d, a, b, k[7], 14, 1735328473);
        b = gg(b, c, d, a, k[12], 20, -1926607734);
        a = hh(a, b, c, d, k[5], 4, -378558);
        d = hh(d, a, b, c, k[8], 11, -2022574463);
        c = hh(c, d, a, b, k[11], 16, 1839030562);
        b = hh(b, c, d, a, k[14], 23, -35309556);
        a = hh(a, b, c, d, k[1], 4, -1530992060);
        d = hh(d, a, b, c, k[4], 11, 1272893353);
        c = hh(c, d, a, b, k[7], 16, -155497632);
        b = hh(b, c, d, a, k[10], 23, -1094730640);
        a = hh(a, b, c, d, k[13], 4, 681279174);
        d = hh(d, a, b, c, k[0], 11, -358537222);
        c = hh(c, d, a, b, k[3], 16, -722521979);
        b = hh(b, c, d, a, k[6], 23, 76029189);
        a = hh(a, b, c, d, k[9], 4, -640364487);
        d = hh(d, a, b, c, k[12], 11, -421815835);
        c = hh(c, d, a, b, k[15], 16, 530742520);
        b = hh(b, c, d, a, k[2], 23, -995338651);
        a = ii(a, b, c, d, k[0], 6, -198630844);
        d = ii(d, a, b, c, k[7], 10, 1126891415);
        c = ii(c, d, a, b, k[14], 15, -1416354905);
        b = ii(b, c, d, a, k[5], 21, -57434055);
        a = ii(a, b, c, d, k[12], 6, 1700485571);
        d = ii(d, a, b, c, k[3], 10, -1894986606);
        c = ii(c, d, a, b, k[10], 15, -1051523);
        b = ii(b, c, d, a, k[1], 21, -2054922799);
        a = ii(a, b, c, d, k[8], 6, 1873313359);
        d = ii(d, a, b, c, k[15], 10, -30611744);
        c = ii(c, d, a, b, k[6], 15, -1560198380);
        b = ii(b, c, d, a, k[13], 21, 1309151649);
        a = ii(a, b, c, d, k[4], 6, -145523070);
        d = ii(d, a, b, c, k[11], 10, -1120210379);
        c = ii(c, d, a, b, k[2], 15, 718787259);
        b = ii(b, c, d, a, k[9], 21, -343485551);
        x[0] = add32(a, x[0]);
        x[1] = add32(b, x[1]);
        x[2] = add32(c, x[2]);
        x[3] = add32(d, x[3]);
      }
      function md51(s) {
        let txt = unescape(encodeURIComponent(s));
        const n = txt.length;
        const state = [1732584193, -271733879, -1732584194, 271733878];
        let i;
        for (i = 64; i <= n; i += 64) calcMD5(state, md5blk(txt.substring(i - 64, i)));
        txt = txt.substring(i - 64);
        const tail = new Array(16).fill(0);
        for (i = 0; i < txt.length; i++) tail[i >> 2] |= txt.charCodeAt(i) << ((i % 4) << 3);
        tail[txt.length >> 2] |= 0x80 << ((txt.length % 4) << 3);
        if (txt.length > 55) {
          calcMD5(state, tail);
          tail.fill(0);
        }
        tail[14] = n * 8;
        calcMD5(state, tail);
        return state;
      }
      function hex(x) {
        const h = [];
        for (let i = 0; i < x.length * 4; i++) {
          h.push(((x[i >> 2] >> ((i % 4) << 3)) & 0xff).toString(16).padStart(2, '0'));
        }
        return h.join('');
      }
      return hex(md51(str));
    }

    function normalizedEmail() {
      return (emailInput.value || '').trim().toLowerCase();
    }

    function cravatarUrl() {
      const email = normalizedEmail();
      if (!email) {
        return 'https://cravatar.cn/avatar?d=identicon&s=160';
      }
      return `https://cravatar.cn/avatar/${md5(email)}?d=identicon&s=160`;
    }

    function updateCravatarPreview() {
      if (document.querySelector('input[name="avatarSource"]:checked').value !== 'gravatar') {
        return;
      }
      previewImage.src = cravatarUrl();
      previewText.textContent = normalizedEmail()
        ? '当前预览：Cravatar 根据邮箱生成。'
        : '当前预览：Cravatar 自动生成（兼容 Gravatar，国内节点加速）。';
    }

    async function checkSession() {
      try {
        const res = await fetch('/api/auth/session', { credentials: 'include' });
        const data = await res.json();
        if (data.authenticated) {
          window.location.replace('/');
        }
      } catch (error) {
        console.warn('Session check failed', error);
      }
    }

    checkSession();

    radioOptions.forEach(option => {
      option.addEventListener('change', handleAvatarChange);
      option.addEventListener('click', () => {
        option.querySelector('input').checked = true;
        handleAvatarChange();
      });
    });

    function handleAvatarChange() {
      radioOptions.forEach(option => option.classList.remove('active'));
      const activeInput = document.querySelector('input[name="avatarSource"]:checked');
      const activeOption = activeInput.closest('.radio-option');
      activeOption.classList.add('active');

      const source = activeInput.value;
      avatarUrlField.classList.toggle('hidden', source !== 'url');
      avatarFileField.classList.toggle('hidden', source !== 'upload');

      if (source === 'gravatar') {
        updateCravatarPreview();
      } else if (source === 'url') {
        const url = form.avatarUrl.value.trim();
        if (url) {
          previewImage.src = url;
          previewText.textContent = '当前预览：自定义链接头像。';
        } else {
          previewImage.src = 'https://cravatar.cn/avatar?d=identicon&s=160';
          previewText.textContent = '请填写头像链接后预览。';
        }
      } else {
        previewImage.src = 'https://cravatar.cn/avatar?d=identicon&s=160';
        previewText.textContent = '上传一张图片作为头像（支持 PNG / JPG / GIF / WebP）。';
      }
    }

    emailInput.addEventListener('input', updateCravatarPreview);

    form.avatarUrl.addEventListener('input', () => {
      if (document.querySelector('input[name="avatarSource"]:checked').value === 'url') {
        const url = form.avatarUrl.value.trim();
        if (url) {
          previewImage.src = url;
          previewText.textContent = '当前预览：自定义链接头像。';
        } else {
          previewImage.src = 'https://cravatar.cn/avatar?d=identicon&s=160';
          previewText.textContent = '请填写头像链接后预览。';
        }
      }
    });

    form.avatarFile.addEventListener('change', () => {
      const file = form.avatarFile.files[0];
      if (!file) {
        previewImage.src = 'https://cravatar.cn/avatar?d=identicon&s=160';
        previewText.textContent = '上传一张图片作为头像（支持 PNG / JPG / GIF / WebP）。';
        return;
      }
      const url = URL.createObjectURL(file);
      previewImage.src = url;
      previewText.textContent = `已选择：${file.name}（${Math.round(file.size / 1024)} KB）`;
    });

    form.addEventListener('submit', async event => {
      event.preventDefault();
      hideMessage();

      if (!form.reportValidity()) {
        return;
      }

      const password = form.password.value;
      const passwordConfirm = form.passwordConfirm.value;

      if (password !== passwordConfirm) {
        return showMessage('两次输入的密码不一致，请重新确认。', 'error');
      }

      const source = form.avatarSource.value;
      if (source === 'url' && !form.avatarUrl.value.trim()) {
        return showMessage('请选择头像来源或填写图片链接。', 'error');
      }
      if (source === 'upload' && form.avatarFile.files.length === 0) {
        return showMessage('请选择要上传的头像图片。', 'error');
      }

      try {
        setSubmitting(true, '正在注册…');
        const formData = new FormData(form);
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          credentials: 'include',
          body: formData
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          const msg = data.message || '注册失败，请稍后再试。';
          showMessage(msg, 'error');
          setSubmitting(false);
          return;
        }

        showMessage('注册成功！验证邮件已发送，请在 24 小时内完成验证。', 'success');
        setSubmitting(true, '即将跳转…');
        setTimeout(() => window.location.replace('/login.html'), 1500);
      } catch (error) {
        console.error(error);
        showMessage('服务器开小差了，请稍后再试。', 'error');
        setSubmitting(false);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (window.location.hash === '#resend') {
        showMessage('如果没有收到验证邮件，请检查垃圾邮件或稍后重试注册。', 'success');
      }
    });

    function showMessage(text, type) {
      messageEl.textContent = text;
      messageEl.className = `message show ${type}`;
    }

    function hideMessage() {
      messageEl.textContent = '';
      messageEl.className = 'message';
    }

    function setSubmitting(active, label) {
      submitBtn.disabled = active;
      submitBtn.querySelector('span').textContent = label || '完成注册并发送验证邮件';
    }

    handleAvatarChange();
    updateCravatarPreview();
  </script>
</body>
</html>
